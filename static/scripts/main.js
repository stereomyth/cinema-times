"use strict";!function(){angular.module("cineworld",["ngAnimate","ngTouch","ngSanitize","ngMessages","ngAria","ngResource","ngRoute","ngStorage"]).config(["$routeProvider","$logProvider","$locationProvider",function(t,e,n){t.when("/",{templateUrl:"views/main/main.html",controller:"MainController",controllerAs:"main"}).otherwise({redirectTo:"/"}),e.debugEnabled(!0),n.html5Mode(!0),localStorage["ngStorage-options"]||(localStorage["ngStorage-options"]=JSON.stringify({typeTabs:"none",panel:"all",clean:!0,cinema:"",hidden:[]})),localStorage["ngStorage-stamps"]||(localStorage["ngStorage-stamps"]=JSON.stringify({}))}]).constant("moment",moment)}(),angular.module("cineworld").factory("Api",["$resource","$localStorage",function(t,e){var n="TNk2:R3P";return t("https://www.cineworld.com/api/quickbook/:route",{key:n,cinema:e.options.cinema,callback:"JSON_CALLBACK"},{get:{method:"JSONP"}})}]),angular.module("cineworld").factory("Films",["$q","$window","$log","$http","$localStorage","Api","moment",function(t,e,n,i,o,l,r){return{get:function(){var e=this,i={route:"films",cinema:o.options.cinema};return t(function(l,s){o.films&&r(o.stamps.films).isSame(r(),"day")?(n.debug("local: films"),l(o.films)):(n.debug("remote: films"),t.all({films:e.films(i),today:e.today(i)}).then(function(t){var e={};t.films.forEach(function(t,n){for(var i in t.types)e[t.types[i].edi]=n}),t.today.forEach(function(n){t.films[e[n.edi]].today=!0}),o.options.hidden.forEach(function(n){t.films[e[n]]&&(t.films[e[n]].hidden=!0)}),o.films=t.films,o.stamps.films=r(),l(t.films)},function(t){s(t)}))})},films:function(e){var n=this;return e.full=!0,t(function(t,i){l.get(e,function(e){t(n.convert(e))},function(t){i(t)})})},today:function(e){return e.date=r().format("YYYYMMDD"),t(function(t,n){l.get(e,function(e){t(e.films)},function(t){n(t)})})},convert:function(t){var e={three:/^\(3[dD]\) /,imax:/^\(IMAX\) /,two:/^\(2[dD]\) /,i3d:/^\((3[dD] IMAX|IMAX 3-?[dD])\) /,unlimited:/ (-\s)?Unlimited (Card\s)?Screening/,dubbed:/ (-\s)?\[Dubbed Version\]/,m4j:/^M4J /,afs:/^Autism Friendly Screening: /},n=t.films.map(function(t){var n=void 0,i=void 0,o={title:t.title,url:t.film_url,classification:t.classification,advisory:t.advisory,poster:t.poster_url,still:t.still_url,types:{}};return e.three.test(t.title)?(n="three",i="3D"):e.imax.test(t.title)?(n="imax",i="IMAX"):e.i3d.test(t.title)?(n="i3d",i="IMAX 3D"):e.unlimited.test(t.title)?(n="unlimited",i="U"):e.m4j.test(t.title)?(n="m4j",i="M4J"):e.afs.test(t.title)?(n="afs",i="AF"):e.dubbed.test(t.title)?(n="dubbed",i="Dub"):(n="two",i="2D"),o.title=t.title.replace(e[n],""),o.types[n]={edi:t.edi,poster:t.poster_url,name:i},o});return n.forEach(function(t,e){if(t)for(var i=e+1;i<n.length;i++)n[i].title===t.title&&(angular.extend(t.types,n[i].types),n[i]="")}),n.filter(function(t){return t})}}}]),angular.module("cineworld").factory("Res",["$q","$log","$localStorage","moment","Api",function(t,e,n,i,o){return{get:function(l,r){return t(function(t,s){if(n[l])e.debug("local:",l),t(n[l]);else{e.debug("remote:",l);var a=angular.extend({route:l},r);o.get(a,function(e){n[l]=e[l],n.stamps[l]=i(),t(e[l])},function(t){s(t)})}})}}}]),angular.module("cineworld").factory("Shows",["$q","$log","$localStorage","moment","Api",function(t,e,n,i,o){return{params:{route:"performances",cinema:n.options.cinema,date:i().format("YYYYMMDD")},get:function(){var o=this;return t(function(t){n.stamps.shows&&i(n.stamps.shows).isSame(i(),"day")?(e.debug("local shows"),t()):(n.films.forEach(function(t){o.film(t)}),t())})},film:function(t){var n=this;t.today&&!t.hidden&&(t.validCount=0,angular.forEach(t.types,function(l){l.shows?(e.debug("local:",t.title,"-",l.name),l.shows=n.gauge(l.shows),l.shows.length&&t.validCount++):(n.params.film=l.edi,o.get(n.params,function(o){e.debug("remote",t.title,l.name),l.shows=[],o.performances.forEach(function(t){var e={stamp:i(t.time,"HH:mm"),time:t.time,url:t.booking_url,subs:t.subtitled};l.shows.push(e)}),l.shows=n.gauge(l.shows),l.shows.length&&t.validCount++}))}))},gauge:function(t){var e=[];return t&&t.length&&t.forEach(function(t){i(t.time,"HH:mm").add(25,"m").isAfter(i())&&e.push(t)}),e}}}]),angular.module("cineworld").directive("film",function(){return{restrict:"A",templateUrl:"components/film/film.html"}}),angular.module("cineworld").directive("showTimes",["Api","$log","moment",function(t,e,n){return{restrict:"A",templateUrl:"components/show-times/show-times.html",scope:{film:"=showTimes"},link:function(i){var o=function(t){return n(t,"hh:mm").add(25,"m").isAfter(n())};t.shows(i.film.edi).then(function(t){i.shows=[],t.forEach(function(t){o(t.time)&&i.shows.push(t)}),i.shows.length<1&&(e.debug("no shows",i.film.title),i.$parent.v.shows=!1)})}}}]),angular.module("cineworld").controller("MainController",["$scope","$log","$localStorage","Res","Films","Shows",function(t,e,n,i,o,l){t.options=n.options,i.get("cinemas",{cinema:null}).then(function(e){t.cinemas=e});var r=function(){o.get().then(function(e){t.films=e,l.get()})};t.options.cinema?r():t.showOptions=!0,t.selectCinema=function(){delete n.films,r()},t.clearAll=function(){n.$reset()},t.clearApi=function(){delete n.films,delete n.cinemas},t.clearHidden=function(){n.options.hidden=[]},t.$watch("options.panel",function(e){t.filter="today"===e?{today:!0}:""});var s=n.options.hidden;t.objl=function(t){return Object.keys(t).length};var a=function(t,e){s.splice(s.findIndex(function(n){return n===t.types[e].edi}),1)};t.toggleHidden=function(t){if(t.hidden){for(var e in t.types)a(t,e);t.hidden=!t.hidden,l.film(t)}else{for(var n in t.types)s.push(t.types[n].edi);t.hidden=!t.hidden}}}]);